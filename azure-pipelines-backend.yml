name: GenAssist-GitHub-Backend_$(Date:yyyyMMdd)$(Rev:.r)

pool:
  name: Ritech-AI-TR1

trigger:
  branches:
    include:
      - development
  paths:
    include:
      - backend/**

pr:
  branches:
    include:
      - development
  paths:
    include:
      - backend/**

steps:
  - checkout: self
    clean: true
    fetchTags: true

  - task: UseDotNet@2
    displayName: 'Use .NET Core sdk 8.X'
    inputs:
      version: 8.x

  - task: gittools.gittools.setup-gitversion-task.gitversion/setup@3
    displayName: 'gitversion-setup'
    inputs:
      versionSpec: 5.x

  - script: |
      echo "stopping existing containers of cicd"
      touch .env
      docker compose -f docker-compose.cicd.yml -p genassist_cicd down --rmi all --volumes --remove-orphans
    workingDirectory: backend
    displayName: 'Stop Test Containers - Before Start'

  - task: DownloadSecureFile@1
    name: cicdenv
    displayName: 'Download .env for CICD'
    inputs:
      secureFile: env.cicd

  - script: |
      set -euo pipefail

      BACKEND_DIR="$(System.DefaultWorkingDirectory)/backend"
      ENV_FILE="$BACKEND_DIR/.env"

      cp "$(cicdenv.secureFilePath)" "$ENV_FILE"
      cd "$BACKEND_DIR"

      branch="$(Build.SourceBranch)"
      branchNo="${branch#refs/heads/}"

      echo -e "\nAPI_VERSION=${branchNo}-$(Build.BuildNumber)" >> "$ENV_FILE"

      esc_sed() { printf '%s' "$1" | sed -e 's/[\/&]/\\&/g'; }

      OAIKEY_ESC="$(esc_sed "$OAIKEY")"
      HFTOKEN_ESC="$(esc_sed "$HFTOKEN")"
      FERNET_KEY_ESC="$(esc_sed "$FERNET_KEY")"
      S3_ACCESS_KEY_ID_ESC="$(esc_sed "$S3_ACCESS_KEY_ID")"
      S3_SECRET_ACCESS_KEY_ESC="$(esc_sed "$S3_SECRET_ACCESS_KEY")"

      sed -i "s/OPENAI_API_KEY_VALUE/${OAIKEY_ESC}/g" "$ENV_FILE"
      sed -i "s/HUGGINGFACE_TOKEN_VALUE/${HFTOKEN_ESC}/g" "$ENV_FILE"
      sed -i "s/FERNET_KEY_VALUE/${FERNET_KEY_ESC}/g" "$ENV_FILE"
      sed -i "s/AWS_ACCESS_KEY_ID_VALUE/${S3_ACCESS_KEY_ID_ESC}/g" "$ENV_FILE"
      sed -i "s/AWS_SECRET_ACCESS_KEY_VALUE/${S3_SECRET_ACCESS_KEY_ESC}/g" "$ENV_FILE"

      sed -i 's/DEBUG=false/DEBUG=true/g' "$ENV_FILE"

      echo -e "\nCREATE_DB=true" >> "$ENV_FILE"
      sed -i 's/DB_HOST=db/DB_HOST=genassist_db/g' "$ENV_FILE"

      echo -e "\nCHROMA_HOST=chroma" >> "$ENV_FILE"
      echo -e "\nCHROMA_PORT=8005" >> "$ENV_FILE"

      echo "starting fresh db"
      docker compose -f docker-compose.cicd.yml -p genassist_cicd up --force-recreate -d db

      echo "starting app and whisper"
      docker compose -f docker-compose.cicd.yml -p genassist_cicd up --build --force-recreate -d app whisper
    workingDirectory: backend
    displayName: 'Build and Start App + Whisper'
    env:
      OAIKEY: $(OAIKEY)
      HFTOKEN: $(HFTOKEN)
      FERNET_KEY: $(FERNET_KEY)
      S3_ACCESS_KEY_ID: $(S3_ACCESS_KEY_ID)
      S3_SECRET_ACCESS_KEY: $(S3_SECRET_ACCESS_KEY)

  - script: |
      set -euo pipefail
      OUT_DIR="$(System.DefaultWorkingDirectory)"
      CONTAINER="genassist-app-cicd"

      echo "=== Basic context ==="
      echo "Agent: $(uname -a)"
      echo "Workdir: $OUT_DIR"
      echo "Container: $CONTAINER"
      docker ps -a --filter "name=${CONTAINER}" --no-trunc || true

      echo "=== Python inside container ==="
      docker exec "$CONTAINER" python --version || true
      docker exec "$CONTAINER" python -c "import sys; print(sys.executable); print(sys.path)" || true

      echo "=== Disk/memory snapshot (host + container) ==="
      df -h || true
      free -h || true
      docker exec "$CONTAINER" sh -lc "df -h; free -h || true; ulimit -a || true" || true

      echo "=== Upgrading pip tooling (verbose) ==="
      docker exec "$CONTAINER" python -m pip install -U pip setuptools wheel

      echo "=== Installing test dependencies (verbose) ==="
      docker exec "$CONTAINER" python -m pip install \
        "pytest>=8.2,<9" \
        "pytest-asyncio>=0.26,<0.27" \
        pytest-cov pytest-azurepipelines coverage

      echo "=== Start tailing container logs (background) ==="
      docker logs -f "$CONTAINER" &
      LOG_PID=$!
      cleanup() { kill "$LOG_PID" 2>/dev/null || true; }
      trap cleanup EXIT

      echo "=== Sanity check: can we see tests dir? ==="
      docker exec -w /src "$CONTAINER" sh -lc "pwd; ls -lah; ls -lah tests | sed -n '1,200p'"

      echo "=== Running pytest (tee to /src/pytest.log) ==="
      TEST_RESULT=0

      # Run from /src so outputs land where you expect; tee captures stdout+stderr to file AND shows it live
      set +e
      docker exec -w /src "$CONTAINER" sh -lc '
        python -m pytest tests -vvv \
          --cov=app --cov-branch --cov-report=xml \
          --junitxml=test-results.xml --cov-report=html \
          --no-coverage-upload -s -o log_cli=true -o log_cli_level=DEBUG \
        2>&1 | tee /src/pytest.log
      '
      PYTEST_EXIT=$?
      set -e

      if [ "$PYTEST_EXIT" -ne 0 ]; then
        echo "❌ Pytest failed with exit code: $PYTEST_EXIT"
        TEST_RESULT=1

        echo "=== Immediate container diagnostics after failure ==="
        echo "--- docker inspect (State) ---"
        docker inspect "$CONTAINER" --format '{{json .State}}' | sed -n '1,200p' || true

        echo "--- last 300 lines of container logs ---"
        docker logs --tail 300 "$CONTAINER" || true

        echo "--- dmesg (kernel OOM/segfault clues) inside container (if permitted) ---"
        docker exec "$CONTAINER" sh -lc "dmesg | tail -n 200" || true

        echo "--- core dumps / crash traces (common paths) ---"
        docker exec -w /src "$CONTAINER" sh -lc "ls -lah .; find / -maxdepth 3 -type f -name 'core*' 2>/dev/null | head -n 50" || true
      else
        echo "✅ Tests passed successfully!"
      fi

      echo "=== Listing /src outputs ==="
      docker exec -w /src "$CONTAINER" sh -lc "ls -lah | sed -n '1,200p'; ls -lah htmlcov 2>/dev/null | sed -n '1,200p' || true"

      echo "=== Copying artifacts to agent workspace ==="
      mkdir -p "$OUT_DIR"

      for f in test-results.xml coverage.xml pytest.log; do
        if docker exec "$CONTAINER" test -f "/src/$f"; then
          docker cp "$CONTAINER:/src/$f" "$OUT_DIR/$f"
          echo "Copied $f"
        else
          echo "⚠️ Missing /src/$f"
        fi
      done

      if docker exec "$CONTAINER" test -d /src/htmlcov; then
        docker cp "$CONTAINER:/src/htmlcov" "$OUT_DIR/htmlcov"
        echo "Copied htmlcov/"
      else
        echo "⚠️ Missing /src/htmlcov"
      fi

      exit $TEST_RESULT


    displayName: 'Start Tests'
    condition: false
    timeoutInMinutes: 3

  - script: |
      docker compose -f docker-compose.cicd.yml -p genassist_cicd down --rmi all --volumes --remove-orphans
    workingDirectory: backend
    displayName: 'Stop Test Containers - After End'
    condition: always()

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFiles: '$(System.DefaultWorkingDirectory)/test-results.xml'
      testRunTitle: 'Backend Tests'
      failTaskOnFailedTests: true
    condition: succeededOrFailed()

  - task: PublishCodeCoverageResults@2
    displayName: 'Publish code coverage results'
    inputs:
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
      pathToSources: '$(System.DefaultWorkingDirectory)/backend/app/'
    condition: succeededOrFailed()

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Pipeline Artifact'
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/backend'
      artifact: code
    condition: succeededOrFailed()