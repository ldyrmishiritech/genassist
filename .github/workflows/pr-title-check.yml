name: PR Title Check

on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title
        uses: actions/github-script@v7
        with:
          script: |
            const title = (context.payload.pull_request.title || "").trim();
            const prNumber = context.payload.pull_request.number;

            const allowedTypes = [
              "feat",
              "fix",
              "docs",
              "style",
              "refactor",
              "test",
              "chore",
              "perf",
              "ci",
              "hotfix",
              "bugfix",
              "security",
              "build",
              "release"
            ];

            // Accept:
            // "<type>: subject"
            // "<type> - subject"
            const match = title.match(/^([a-zA-Z]+)\s*[:\-]\s*(\S.+)$/);
            const type = match?.[1]?.toLowerCase();
            const subject = match?.[2];

            const valid = Boolean(type && allowedTypes.includes(type) && subject);

            const guidance = `
              PR title must start with one of the allowed types, followed by ":" or "-", then a short description.
              
              Allowed types:
              ${allowedTypes.map(t => `- ${t}`).join("\n")}
              
              Accepted formats:
              - feat: add login
              - chore - bump dependencies
              - fix: handle edge case
              - docs - update README
              `.trim();
              
                          async function upsertComment(body) {
                            const { data: comments } = await github.rest.issues.listComments({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: prNumber,
                              per_page: 100,
                            });
              
                            const marker = "<!-- pr-title-check -->";
                            const existing = comments.find(
                              c => c.user?.type === "Bot" && c.body?.includes(marker)
                            );
              
                            const fullBody = `${marker}\n${body}`;
              
                            if (existing) {
                              await github.rest.issues.updateComment({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                comment_id: existing.id,
                                body: fullBody,
                              });
                            } else {
                              await github.rest.issues.createComment({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                issue_number: prNumber,
                                body: fullBody,
                              });
                            }
                          }
              
                          if (!valid) {
                            await upsertComment(
                              `‚ùå **PR title check failed**\n\nCurrent title: \`${title || "(empty)"}\`\n\n${guidance}`
                            );
                            core.setFailed(`Invalid PR title: "${title}"`);
                            return;
                          }

            core.info(`PR title valid: ${title}`);
